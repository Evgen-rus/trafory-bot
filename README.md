# Телеграм-бот базы знаний Trafory

Телеграм-бот для поиска информации в базе знаний платформы Trafory с использованием векторного поиска FAISS и GPT-4-mini.

## Структура проекта

```
trafory_bot/
├── main.py                  # Главный файл с запуском бота
├── config.py                # Конфигурация (токены API)
├── kb_processor.py          # Обработка и векторизация базы знаний
├── kb_search.py             # Поиск по векторизованной базе знаний
├── openai_service.py        # Сервис для работы с OpenAI API
├── bot_handlers.py          # Обработчики сообщений бота
├── .env                     # Файл с секретными ключами
├── example.env              # Пример конфигурации окружения
├── .gitignore              # Настройки игнорирования файлов
├── requirements.txt         # Зависимости проекта
├── token_usage_stats.json   # Статистика использования токенов
├── knowledge_base/         # База знаний Trafory
│   └── База знаний платформы Trafory/
└── data/
    └── faiss_index/        # Хранилище для векторного индекса
        ├── faiss_index.bin # Индекс FAISS
        ├── metadata.pickle # Метаданные индекса
        └── token_stats.pickle # Статистика токенов
```

## Возможности

- Семантический поиск по базе знаний с использованием FAISS
- Генерация ответов с помощью GPT-4-mini на основе найденного контекста
- Подсчет и отслеживание использования токенов API OpenAI
- Фильтрация запросов не по теме базы знаний
- Периодическое логирование статистики использования
- Асинхронная обработка запросов для высокой производительности

## Требования

- Python 3.9+
- Aiogram 3.17.0+
- OpenAI API 1.66.3
- FAISS
- Dotenv

## Установка и запуск

### 1. Установите зависимости

```bash
pip install -r requirements.txt
```

### 2. Настройте Git для длинных путей

Для корректной работы с базой знаний настройте Git:

```bash
# Для текущего репозитория
git config --local core.longpaths true
```

### 3. Настройте переменные окружения

```bash
# Создайте .env из примера
cp example.env .env
```

Отредактируйте файл `.env`:
- `TELEGRAM_BOT_TOKEN` - токен вашего Telegram бота
- `OPENAI_API_KEY` - ваш API ключ OpenAI
- `OPENAI_MODEL` - модель для генерации ответов (по умолчанию gpt-4o-mini)
- `EMBEDDING_MODEL` - модель для создания эмбеддингов (по умолчанию text-embedding-ada-002)

### 4. Подготовьте базу знаний

База знаний должна находиться в папке `knowledge_base/База знаний платформы Trafory/`.
Выполните векторизацию:

```bash
python kb_processor.py
```

### 5. Запустите бота

```bash
python main.py
```

## Использование

После запуска бота, вы можете взаимодействовать с ним в Telegram:

- `/start` - начать работу с ботом
- `/help` - получить справку о возможностях бота
- `/stats` - получить статистику использования токенов OpenAI API
- `/about` - информация о боте и его возможностях
- Отправьте любой вопрос о платформе Trafory в текстовом формате

Бот автоматически найдет наиболее релевантную информацию в базе знаний и сформирует ответ с помощью GPT-4-mini.

## Мониторинг использования токенов

Бот ведет учет использования токенов OpenAI API:
- Количество токенов при создании эмбеддингов для базы знаний
- Количество токенов при поисковых запросах
- Количество токенов при генерации ответов

Статистика автоматически логируется каждый час и сохраняется в файл `token_usage_stats.json`.
Также доступна через команду `/stats` в интерфейсе бота.

## Примеры запросов

- "Как добавить нового пользователя?"
- "Что такое штатная единица?"
- "Как настроить орг.структуру компании?"
- "Как сбросить пароль пользователя?"

## Особенности работы с базой знаний

- База знаний хранится в формате Markdown файлов
- Поддерживается вложенная структура папок
- Автоматическое разбиение на смысловые чанки
- Сохранение иерархии документов
- Обработка заголовков и форматирования

## Известные ограничения

- Длинные пути файлов (>260 символов) требуют настройки Git
- При обновлении базы знаний требуется повторная векторизация

## Важно!

Этот бот работает только с предоставленной базой знаний и не придумывает информацию. Если в базе знаний нет ответа на вопрос, бот честно сообщит об этом. Запросы, не относящиеся к платформе Trafory, будут вежливо отклонены.
